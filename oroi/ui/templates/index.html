<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <title>DeclarationNav</title>


  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>

    <!-- development version, includes helpful console warnings -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <!-- production version, optimized for size and speed
  <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->


  <!-- it is fair to say we got no style <link href="style.css" rel="stylesheet"> -->
  <style>
  </style>
</head>

<body class="bg-light">

  <main role="main">

  <div id="search-app">
    <search></search>
  </div>


  </main>

  <footer class="text-muted">
    <div class="container">
      <p class="float-right">
        <a href="#">Back to top</a>
      </p>
    </div>
  </footer>
</body>

{% verbatim %}
<script type="text/x-template" id="search">
<div>
    <section class="jumbotron text-center">
      <div class="container">
        <h1>Declaration Nav</h1>
        <p class="lead text-muted">Search declarations of interest made by members of local and national governing bodies</p>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Regular</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="advanced-filter-tab" data-toggle="tab" href="#advanced-filter" role="tab" aria-controls="advanced-filter" aria-selected="false">Advanced</a>
          </li>
        </ul>

        <div class="tab-content mb-3">

          <div class="tab-pane show active" id="home" role="tabpanel" aria-labelledby="home-tab">
            <div class="card card-body text-left border-top-0 rounded-0" >

              <div class="input-group">
                <input type="text" name="search" v-model="queryObj.search" class="form-control" placeholder="Search" v-on:keyup.enter="query" />
                <div class="input-group-append">
                  <button name="search-btn" class="btn btn-primary" v-on:click.prevent="query">Search</button>
                </div>
              </div>

            </div>
          </div>

        <!-- advanced filter -->
        <div class="tab-pane" id="advanced-filter" role="tabpanel" aria-labelledby="advanced-filter-tab">
          <div class="card card-body text-left border-top-0">

            <h5>Special search terms</h5>
            <p>Specific fields can be searched using text search "field.name<strong>:</strong>search terms". For example "<a href="" v-on:click.prevent="queryObj.search = 'description:example'; query();">description:example</a>". Available fields are: <code>description</code>, <code>member.name</code>, <code>received_by_body.name</code>, <code>member.role</code>,            <code>interest.donor</code>, <code>member.name</code>, <code>category</code>, <code>description</code>, <code>body.name</code> and <code>role</code></p>

            <div class="form-row">
              <div class="form-group col">
                <input type="text" name="search" v-model="queryObj.search" class="form-control" placeholder="Search" v-on:keyup.enter="query" />
              </div>
              <div class="col-md-1">
                <!-- TODO add multiple searches? -->
              </div>
            </div>

            <h5>Filter fields</h5>
            <p>The search results can be further filtered by adding exact matches</p>

            <advanced-filter v-for="filter in advancedFilters" v-bind:filterId="filter.id" v-bind:queryObj="queryObj" v-bind:key="filter.id" v-on:rm-advanced-filter="removeAdvancedFilter" v-on:filter-updated="updateAdvancedFilter"></advanced-filter>

            <div class="form-row">
              <div class="form-group ml-auto">
                <button type="button" class="btn btn-secondary text-monospace" v-on:click.prevent="addAdvancedFilter">+</button>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-2">
                <button name="search-btn" class="btn btn-primary" v-on:click.prevent="query">Search</button>
              </div>
            </div>

          </div>
        </div>
        <!-- end advanced filter -->

      </div> <!-- end tab content -->

      <div>
        <template v-for="(item, key, i) in queryObj">
          <template v-if="Array.isArray(item) && key && key != 'facet_size_all'">
            <!-- we are going to assume arrays are advanced filters for now -->
            <span class="badge badge-dark mr-1" v-for="advancedItemValue in item">{{key|underscoresToSpace}} : {{advancedItemValue|decodeURI|underscoresToSpace}} <a class="text-reset" href="#" v-on:click.prevent="removeAdvancedFilterByKeyValue(key, advancedItemValue)">&times;</a></span>
          </template>
          <template v-else>
            <span class="badge badge-secondary mr-1" v-if="key != 'facet_size_all'" >{{key|underscoresToSpace}} : {{item|decodeURI|underscoresToSpace}} <a class="text-reset" href="#" v-on:click.prevent="removeFromQuery(key)">&times;</a></span>
          </template>

        </template>
      </div>
    </div> <!-- end container-->
  </section>

    <section>
      <div class="m-4 row">
          <!-- facets / aggregates -->
          <div class="col-2 mt-2">

            <div class="d-flex flex-column bg-light rounded">
              <h5>Bodies</h5>
              <ul class="list-group">
                <li class="list-group-item" v-for="body in facets._filter_body_name.body_name.buckets"><a href="#" v-on:click.prevent="queryObj.body_name = body.key; query();"> {{body.key}} ({{body.doc_count}})</a></li>
                <li v-if="facets._filter_body_name.body_name.buckets.length == 10" class="list-group-item"><a href="" v-on:click.prevent="updateFacetSize('body_name');">Show all</a></li>
              </ul>
              <hr />
              <h5>Categories</h5>
              <ul class="list-group">
                <li class="list-group-item" v-for="category in facets._filter_category.category.buckets">
                  <a href="" v-on:click.prevent="queryObj.category = category.key; query();"> {{category.key|capitalise|underscoresToSpace}} ({{category.doc_count}})</a>
                </li>
                <li v-if="facets._filter_category.category.buckets.length == 50" class="list-group-item"><a href="" v-on:click.prevent="updateFacetSize('category');">Show all</a></li>
              </ul>
              <hr />
              <h5>Members</h5>
              <ul class="list-group">
                <li class="list-group-item" v-for="member in facets._filter_member_name.member_name.buckets">
                  <a href="" v-on:click.prevent="queryObj.member_name = member.key; query();"> {{member.key}} ({{member.doc_count}})</a>
                </li>
                <li class="list-group-item" v-if="facets._filter_member_name.member_name.buckets.length == 10"><a href="" v-on:click.prevent="updateFacetSize('member_name');">Show all</a></li>
              </ul>
            </div>

          </div>
          <!-- end facets / aggregates -->

          <!-- results -->
          <div class="col">

            <div class="d-flex flex-column">

              <div class="row">
                <p v-if="results.length">Total of {{totalResults}} results</p>
                <p v-else>No results</p>

                <p class="ml-auto">Download (<a v-bind:href="currentCsvUrl">CSV</a>, <a v-bind:href="currentApiUrl">JSON API</a>)</p>
              </div>

              <declaration-result v-for="result in results" v-bind:result="result" v-bind:key="result.id"></declaration-result>

              <div class="row">
                <button v-if="nextPage" class="btn btn-secondary" v-on:click="queryObj.page = nextPage; query(true);" >More results</button>
              </div>

            </div>
          </div>
      </div>
      </section>
    </div>
</script>

<script type="text/x-template" id="declaration-result-template">
  <div class="row mb-3 p-3 border bg-white rounded">
    <div class="d-flex flex-row">
      <div class="d-flex flex-column">
        <h3>{{result.member.name}}</h3>
        <p class="mb-0" v-if="result.member.political_party"><strong>Political party:</strong> {{result.member.political_party}}</p>
        <p class="mb-0" v-if="result.member.role"><strong>In role:</strong> {{result.member.role}}</p>
        <p class="mb-0" ><strong>Category:</strong> {{result.category|underscoresToSpace}}</p>
        <p class="mb-0" ><strong>Declared to body:</strong> {{result.body_received_by.name}}</p>
        <p class="mb-0" v-if="result.register_date"><strong>Register date:</strong> {{result.register_date|dateString}}</p>
        <p class="mb-0" v-if="result.interest_date"><strong>Interest date:</strong> {{result.interest_date|dateString}}</p>
        <p class="mb-0" v-if="result.donor"></strong>Donor:</strong> {{result.donor}}</p>

        <p class="mt-2"><strong>Description:</strong></p>
        <p>{{result.description}}</p>

        <div class="d-flex flex-column" style="font-size: 0.9em">
          <h6>Links:</h6>
          <ul>
            <li><a v-bind:href="result.source" v-bind:title="result.source">Data source (Fetched {{result.fetched|dateString}})</a></li>
            <li>
              Search for '{{result.member.name}}' on;
               <a v-bind:href="'https://duckduckgo.com/?q='+result.member.name">DuckDuckGo</a>
               <a v-bind:href="'https://google.com/?q='+result.member.name">Google</a>
               <a v-bind:href="'https://aleph.occrp.org/search?filter%3Acountries=gb&sort=dates%3Adesc&limit=30&q='+result.member.name">OCCRP Aleph</a>
               <a v-bind:href="'https://publicwhip.org.uk/search.php?query='+result.member.name">ThePublicWhip</a>

               <a v-if="result.source.indexOf('theyworkforyou') > 0 || result.source.indexOf('parliament.uk') > 0 " v-bind:href="'https://www.theyworkforyou.com/search/?q='+result.member.name">TheyWorkForYou</a>

            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</script>


<script type="text/x-template" id="advanced-filter-template">
  <div class="form-row">
    <div class="form-group col-md-2">
        <select class="form-control" v-model="field">
          <option disabled value="">Select field...</option>
          <!-- api/views.py filter_fields -->
          <option value="description">Description</option>
          <option value="member_name">Member name</option>
          <option value="body_name">Body name</option>
          <option value="category">Category</option>
        </select>
    </div>

    <div class="form-group col-md-2">
        <select class="form-control" v-model="filter">
          <option disabled value="">Select filter type...</option>
          <!-- https://django-elasticsearch-dsl-drf.readthedocs.io/en/latest/filtering_usage_examples.html  -->
          <option value="contains">Contains exactly</option>
          <option value="startswith">Starts with exactly</option>
          <option value="endswith">Ends with exactly</option>
        </select>
    </div>

    <div class="form-group col">
        <input type="text" id="contains_text" class="form-control" v-model="value" placeholder="text" />
    </div>

    <div class="form-group col-md-1 mb-5">
      <button type="button" class="btn btn-secondary position-absolute text-monospace" style="right: 0" v-on:keyup.prevent="" v-on:click.prevent="$emit('rm-advanced-filter', filterId)">-</button>
    </div>
  </div>

</script>

{% endverbatim %}

<script>

var apiUrl = "{% url "api:declaration-list" %}"
var csvUrl = "{% url "ui:csv-download" %}"

</script>

<script>
  Vue.component('declaration-result', {
    template: '#declaration-result-template',
    props: {
      result: { type: Object },
    },
  });

  Vue.component('search', {
    template: '#search',

    data: function(){
      return {
        results: [],
        facets: {},
        totalResults: 0,
        resultsStart: 0,
        resultsEnd: 0,
        nextPage: undefined,
        delayedQueryTimer: undefined,
        queryObj: {},
        currentApiUrl: undefined,
        currentCsvUrl: undefined,
        advancedFilters: [],
      }
    },

    watch: {
      "queryObj.search": 'delayedQuery',
    },

    created: function () {
        let ctx = this;
        /* Take the search query from the url query param if it
         * exists */
        window.onpopstate = function(event) {
          if (event.state && event.state.queryObj) {
            ctx.queryObj = event.state.queryObj;
            ctx.query(true);
          }
        }

        /* Load the search from url query*/
        if (window.location.search){
          let urlObj = this.urlQueryToObj(window.location.search);
          this.queryObj = urlObj;

          /* Update facet size separately to ensure we have an array */
          this.queryObj.facet_size_all = null;
          this.updateFacetSize(urlObj.facet_size_all);
        }

        this.addAdvancedFilter();

        this.query(true);
    },

    methods: {

      reset: function(){
        this.total_results = 0;
        this.results = [];
        this.nextPage = null;
        this.facets = {};
      },

      urlQueryToObj: function(url){
        /* Turns a GET query into an object */
        var string = url.split("?")[1];

        var stringArray = string.split("&");
        var obj = {};

        for (var i in stringArray) {
          var keyVal = stringArray[i].split("=");
          if (keyVal[1]){
            obj[keyVal[0]] = keyVal[1];
          }
        }
        return obj;
      },

      objToUrlQuery: function (obj){
        /* Turns an object into GET query */
        var str = "?";

        for (var key in obj){
          if (!obj[key])
            continue;

          /* Unpack arrays */
          if (Array.isArray(obj[key])){
            for(var i in obj[key]){
              str += key + "=" + obj[key][i] + "&";
            }
            continue;
          }

          str += key+ "="+obj[key].toString();
          str += "&";
        }

        /* Maintain the current hash */
        str += window.location.hash;
        return str;
      },

      removeFromQuery: function(key){
        delete this.queryObj[key];
        this.query();
      },

      updateFacetSize: function(facet){
        if (!facet){
          return;
        }

        if (!this.queryObj.facet_size_all){
          this.queryObj.facet_size_all = [ facet ];
        } else {
          this.queryObj.facet_size_all.push(facet);
        }

        this.query();
      },

      updateAdvancedFilter: function(advancedFilter){
        /* Find it and update it */
        console.log(advancedFilter);
        for (filterI in this.advancedFilters){
          let filterObj = this.advancedFilters[filterI];

          if (filterObj.id == advancedFilter.id){
            filterObj.value = advancedFilter.value;
            filterObj.key = advancedFilter.key;
            break;
          }
        }
      },

      updateAdvancedFiltersInQueryObj: function(){
        /* Remove any old filters from the queryObj */
        for (filterI in this.advancedFilters){
          delete this.queryObj[this.advancedFilters[filterI].key];
        }

        /* And now add the new ones in */
        for (filterI in this.advancedFilters){
          let filterObj = this.advancedFilters[filterI];

          if (!filterObj.key || !filterObj.value){
            continue;
          }

          /* Initialise the array for this key if needed
          *  Filters are always arrays as they are infinitely chain-able
          */
          if (!this.queryObj[filterObj.key]){
            this.queryObj[filterObj.key] = [];
          }

          this.queryObj[filterObj.key].push(filterObj.value);
        }

      },

      addAdvancedFilter: function(){
        /* We use the epoch here to generate filter id as there is nothing else
         * that can uniquely identify the filter (all the content can be the same as
         * they're chain-able)
        */
        this.advancedFilters.push({ id: 'filter-'+Date.now(), value: '', key:''})
      },

      removeAdvancedFilter: function(filterId){
        /* Find and Remove from our list of filters by filter id */
        for (filterI in this.advancedFilters){
          let filterObj = this.advancedFilters[filterI];

          if (filterObj.id == filterId){
            delete this.queryObj[filterObj.key];
            this.advancedFilters.splice(filterI, 1);
            break;
          }

        }

        this.query();
      },

      removeAdvancedFilterByKeyValue: function(key, value){
        for (filterI in this.advancedFilters){
          let filterObj = this.advancedFilters[filterI];
          if (filterObj.key == key && filterObj.value == value){
            this.removeAdvancedFilter(filterObj.id);
          }
        }
      },

      delayedQuery: function(){
        if (this.delayedQueryTimer){
          window.clearTimeout(this.delayedQueryTimer);
        }

        this.reset();

        let ctx = this;

        this.delayedQueryTimer = window.setTimeout(function(){
          ctx.query();
        }, 1000);
      },

      query: function(paging){
        let ctx = this;
        let url;
        let queryParams;

        /* Any other change in the query we need to start again from page 0 */
        if (!paging){
          delete this.queryObj['page'];
          this.nextPage = undefined;
        }

        /* Avoid double querying  - once from typing , once from enter/click search */
        if (this.delayedQueryTimer){
          window.clearTimeout(this.delayedQueryTimer);
        }

        /* See if we need to update any Advanced Filters we may have */
        this.updateAdvancedFiltersInQueryObj();

        /* Save the state in browser history */
        window.history.pushState({ queryObj: this.queryObj }, "q", this.objToUrlQuery(this.queryObj));

        console.log(this.queryObj);

        /* Create the url for this query */
        queryParams = this.objToUrlQuery(this.queryObj);
        this.currentApiUrl = apiUrl + queryParams;
        this.currentCsvUrl = csvUrl + queryParams;

        /* Do the API request */
        $.getJSON(this.currentApiUrl, function(data){
          ctx.results = data.results;
          ctx.totalResults = data.count;

          if (ctx.queryObj.search){
            ctx.queryObj.search = decodeURI(ctx.queryObj.search);
          }

          ctx.facets = data.facets;
          if (data.next){
            /* extract the next page number for future use. We want the
             * queryObj to the be ssot on the query state
             */
            ctx.nextPage = ctx.urlQueryToObj(data.next).page
          }
          if (ctx.totalResults === 0){
            ctx.results = [];
          }

        });
      },
    }
  });

  Vue.component('advanced-filter', {
    template: '#advanced-filter-template',
    props: {
      queryObj: { type: Object },
      filterId: { type: String },
    },

    data: function(){
      return {
        field: "",
        filter: "",
        value: "",
     }
    },

    watch: {
      "field": 'updateObj',
      "filter":'updateObj',
      "value": 'updateObj',
    },

    methods: {
      updateObj: function(){
        if (!this.field || !this.filter || !this.value){
          return;
        }

        let newFilter = {
          id: this.filterId,
          key: this.field + "__" + this.filter,
          value: this.value,
        };

       this.$emit("filter-updated", newFilter);
      },
    }


  });



  Vue.filter('decodeURI', function (val) {
      return decodeURI(val);
    });

  Vue.filter('capitalise', function (value) {
      if (!value) return ''
      value = value.toString()
      return value.charAt(0).toUpperCase() + value.slice(1)
    });

  Vue.filter('underscoresToSpace', function (value) {
    return value.replace(/_/g, " ")
  });

  Vue.filter('dateString', function (value) {
    return new Date(value).toString();
  });

  new Vue({
    el: "#search-app",
  });
</script>

</html>