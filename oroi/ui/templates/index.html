<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <title>DeclarationNav</title>


  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>

    <!-- development version, includes helpful console warnings -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <!-- production version, optimized for size and speed
  <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->


  <!-- it is fair to say we got no style <link href="style.css" rel="stylesheet"> -->
  <style>
  </style>
</head>

<body class="bg-light">
  <main role="main">

  <div id="search-app">
    <search query="{{view.request.GET.q}}"></search>
  </div>


  </main>

  <footer class="text-muted">
    <div class="container">
      <p class="float-right">
        <a href="#">Back to top</a>
      </p>
    </div>
  </footer>
</body>

{% verbatim %}
<script type="text/x-template" id="search">
  <div>
    <section class="jumbotron text-center">
      <div class="container">
        <h1>Declaration Nav</h1>
        <p class="lead text-muted">Search for people, public bodies and interests</p>
        <div class="input-group">
          <input type="text" name="search" v-model="queryObj.search" class="form-control" placeholder="Search" v-on:keyup.enter="query" />
          <div class="input-group-append">
            <button name="search-btn" class="btn btn-primary" v-on:click.prevent="query">Search</button>
          </div>
        </div>
        <div>
          <span class="badge badge-secondary mr-1" v-for="(item, key, i) in queryObj">{{key}} : {{item|decodeURI}} <a class="text-reset" href="#" v-on:click.prevent="removeFromQuery(key)">&times;</a> </span>
        </div>
      </div>
    </section>

    <div class="m-4 d-flex flex-row">

      <div class="d-flex flex-column pl-3 pr-3 bg-light rounded">
        <h5>Public Bodies</h5>
        <ul class="list-group">
          <li class="list-group-item" v-for="body in facets._filter_body_name.body_name.buckets"><a href="#" v-on:click.prevent="queryObj.body_name = body.key; query();"> {{body.key}} ({{body.doc_count}})</a></li>
        </ul>
        <hr />
        <h5>People</h5>
        <ul class="list-group">
          <li class="list-group-item" v-for="member in facets._filter_member_name.member_name.buckets">
            <a href="" v-on:click.prevent="queryObj.member_name = member.key; query();"> {{member.key}} ({{member.doc_count}})</a>
          </li>
        </ul>
      </div>

      <div class="flex-fill bg-white rounded p-3 border">
        <p v-if="results.length">Showing {{results.length}} of {{total_results}} results</p>
        <p v-else>No results</p>
        <declaration-result v-for="result in results" v-bind:result="result" v-bind:key="result.id"></declaration-result>
        <button v-if="results.length < total_results" class="btn btn-secondary" v-on:click="query">More</button>
      </div>

    </div>

  </div>
</script>

<script type="text/x-template" id="declaration-result-template">
  <div class="row m-4 border-bottom">
    <div class="d-flex flex-row">
      <div class="d-flex flex-column">
        <h3>{{result.member.name}}</h3>
        <p>In role: {{result.member.role}}</p>

        <h5>Category: {{result.interest.category}}</h5>
        <p>{{result.interest.description}}</p>

        <p v-if="result.interest.donor">Donor: {{result.interest.donor}}</p>

        <h5>Body: {{result.body_received_by.name}}</p></h5>
        <p><small><a v-bind:href="result.source">{{result.source}}</a></small></p>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="facets-result-template">
  <div class="row m-4 border-bottom">
    <div class="d-flex flex-row">
    </div>
  </div>
</script>


{% endverbatim %}

<script>
  Vue.component('declaration-result', {
    template: '#declaration-result-template',
    props: {
      result: { type: Object },
    },
  });

  Vue.component('search', {
    template: '#search',

    data: function(){
      return {
        results: [],
        facets: {},
        total_results: 0,
        next_page_url: undefined,
        delayedQueryTimer: undefined,
        queryObj: {} ,
      }
    },

    watch: {
      "queryObj.search": 'delayedQuery',
    },

    created: function () {
        let ctx = this;
        /* Take the search query from the url query param if it
         * exists on load */
        window.onpopstate = function (event) {
          console.log("state popped");
          if (event.state && event.state.query) {
            ctx.queryObj.search = event.state.query;
          }
        }

        /* Load the search from url query */
        if (window.location.search){
          this.queryObj = this.urlQueryToObj();
        }
        this.query();
    },

    filters: {
      decodeURI : function(val){
        return decodeURI(val);
      },

    },

    methods: {

      reset: function(){
        this.total_results = 0;
        this.results = [];
        this.next_page_url = null;
        this.facets = {};
      },

      urlQueryToObj: function(){
        /* Turns a GET query into an object */
        var string = window.location.search;
        string = string.substr(1);
        var stringArray = string.split("&");
        var obj = {};

        for (var i in stringArray) {
          var keyVal = stringArray[i].split("=");
          if (keyVal[1]){
            obj[keyVal[0]] = keyVal[1];
          }
        }

        return obj;
      },

      objToUrlQuery: function (obj){
        /* Turns an object into GET query */
        var str = "?";

        for (var key in obj){
          if (obj[key] === undefined)
            continue;

          str += key+ "="+obj[key].toString();
          str += "&";
        }

        /* Maintain the current hash */
        str += window.location.hash;

        return str;
      },

      removeFromQuery: function(key){
        delete this.queryObj[key];
        this.query();
      },

      delayedQuery: function(){
        if (this.delayedQueryTimer){
          window.clearTimeout(this.delayedQueryTimer);
        }

        this.reset();

        let ctx = this;

        this.delayedQueryTimer = window.setTimeout(function(){
          ctx.query();
        }, 1000);
      },

      query: function(){
        let ctx = this;
        let url;

        console.log(this.queryObj);
        window.history.pushState({ queryObj: this.queryObj }, "q", this.objToUrlQuery(this.queryObj));


        /* Avoid double querying  - once from typing , once from enter/click search */
        if (this.delayedQueryTimer){
          window.clearTimeout(this.delayedQueryTimer);
        }

        url = "/api/Declarations/"+this.objToUrlQuery(this.queryObj);
        this.results = [];
        this.total_results = 0;

        console.log(url);

        $.getJSON(url, function(data){
          ctx.results = ctx.results.concat(data.results);
          ctx.total_results = data.count;
          ctx.facets = data.facets;
          if (data.next){
            console.log("next url");
            console.log(data.next);
          }
          if (ctx.total_results === 0){
            ctx.results = [];
          }
        });

      },

    }

  });

  new Vue({
    el: "#search-app",
  });
</script>

</html>